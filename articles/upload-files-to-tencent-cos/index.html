<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>静态资源上传至腾讯云进行加速 | Anonymity94</title>
    <meta name="description" content="Just do IT.">
    <link rel="icon" href="/avatar.png">
  <meta author="anonymity94">
    
    <link rel="preload" href="/assets/css/0.styles.78cb79ba.css" as="style"><link rel="preload" href="/assets/js/app.c731b61c.js" as="script"><link rel="preload" href="/assets/js/2.7021f184.js" as="script"><link rel="preload" href="/assets/js/18.12e20ca7.js" as="script"><link rel="preload" href="/assets/js/12.36288b32.js" as="script"><link rel="prefetch" href="/assets/js/10.2aa202b8.js"><link rel="prefetch" href="/assets/js/11.94323dc4.js"><link rel="prefetch" href="/assets/js/13.446a861d.js"><link rel="prefetch" href="/assets/js/14.2a28af99.js"><link rel="prefetch" href="/assets/js/15.929c061b.js"><link rel="prefetch" href="/assets/js/16.349beaa3.js"><link rel="prefetch" href="/assets/js/17.ca8543d1.js"><link rel="prefetch" href="/assets/js/19.1bdc835b.js"><link rel="prefetch" href="/assets/js/20.0110c185.js"><link rel="prefetch" href="/assets/js/21.c2358486.js"><link rel="prefetch" href="/assets/js/22.1604085f.js"><link rel="prefetch" href="/assets/js/23.c4155c42.js"><link rel="prefetch" href="/assets/js/24.2ee4a564.js"><link rel="prefetch" href="/assets/js/25.2216b279.js"><link rel="prefetch" href="/assets/js/26.f3f9b536.js"><link rel="prefetch" href="/assets/js/27.f3be5151.js"><link rel="prefetch" href="/assets/js/28.99bc744c.js"><link rel="prefetch" href="/assets/js/29.16ad8838.js"><link rel="prefetch" href="/assets/js/3.62a069da.js"><link rel="prefetch" href="/assets/js/30.07e23d36.js"><link rel="prefetch" href="/assets/js/31.816c7346.js"><link rel="prefetch" href="/assets/js/32.34a8e342.js"><link rel="prefetch" href="/assets/js/33.eddd3d1a.js"><link rel="prefetch" href="/assets/js/34.e6792a3d.js"><link rel="prefetch" href="/assets/js/35.61f55c81.js"><link rel="prefetch" href="/assets/js/36.9a7888ad.js"><link rel="prefetch" href="/assets/js/37.34c83d09.js"><link rel="prefetch" href="/assets/js/38.79c435b2.js"><link rel="prefetch" href="/assets/js/39.e83ac360.js"><link rel="prefetch" href="/assets/js/4.9be7231c.js"><link rel="prefetch" href="/assets/js/40.b8783bac.js"><link rel="prefetch" href="/assets/js/5.4c660a59.js"><link rel="prefetch" href="/assets/js/6.2a5b040a.js"><link rel="prefetch" href="/assets/js/7.f9c12c03.js"><link rel="prefetch" href="/assets/js/8.c7d52026.js"><link rel="prefetch" href="/assets/js/9.866a33ab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78cb79ba.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Anonymity94</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/collections/" class="nav-link">收藏夹</a></div><div class="nav-item"><a href="/archive/" class="nav-link">归档</a></div><div class="nav-item"><a href="/experimentation/" class="nav-link">试验场</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/Anonymity94" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/collections/" class="nav-link">收藏夹</a></div><div class="nav-item"><a href="/archive/" class="nav-link">归档</a></div><div class="nav-item"><a href="/experimentation/" class="nav-link">试验场</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/Anonymity94" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>静态资源上传至腾讯云进行加速</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/upload-files-to-tencent-cos/#背景" class="sidebar-link">背景</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#创建存储桶" class="sidebar-link">创建存储桶</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#获取存储桶名称和所属地域" class="sidebar-link">获取存储桶名称和所属地域</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#获取-secretid-和-secretkey" class="sidebar-link">获取 SecretId 和 SecretKey</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#编写上传脚本" class="sidebar-link">编写上传脚本</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#修改-package-json" class="sidebar-link">修改 package.json</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#修改-assetspublicpath" class="sidebar-link">修改 assetsPublicPath</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#修改-webpack-构建脚本" class="sidebar-link">修改 webpack 构建脚本</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/upload-files-to-tencent-cos/#done" class="sidebar-link">Done!</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="静态资源上传至腾讯云进行加速"><a href="#静态资源上传至腾讯云进行加速" aria-hidden="true" class="header-anchor">#</a> 静态资源上传至腾讯云进行加速</h1> <div class="post-meta" data-v-7b3ac6b7><span class="post-time" data-v-7b3ac6b7><span class="post-meta-item-text" data-v-7b3ac6b7>
      发布于:
    </span> <time itemprop="dateCreated" datetime="2019-03-21T13:54:20.000Z" data-v-7b3ac6b7>
      2019-03-21
    </time></span> <div class="post-category" data-v-7b3ac6b7><span itemprop="tag" data-v-7b3ac6b7><a href="/archive/?tag=nodejs" data-v-7b3ac6b7><span class="tag sm" data-v-7b3ac6b7>
          nodejs
        </span></a></span></div></div> <h2 id="背景"><a href="#背景" aria-hidden="true" class="header-anchor">#</a> 背景</h2> <p>之前的一个vue项目，有个1M带宽的测试服务器，每次构建发布后预览起来都特别慢。所以把构建后的静态资源都丢到腾讯云上去加速了。这里把处理流程简单的记录下。</p> <blockquote><p>参考资料：<br> <a href="https://cloud.tencent.com/document/product/436/8629" target="_blank" rel="noopener noreferrer">腾讯云 Node.js SDK 文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://cloud.tencent.com/document/product/436/7751#.E6.9C.AF.E8.AF.AD.E4.BF.A1.E6.81.AF" target="_blank" rel="noopener noreferrer">COS 术语信息<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <h2 id="创建存储桶"><a href="#创建存储桶" aria-hidden="true" class="header-anchor">#</a> 创建存储桶</h2> <p>不做赘述。</p> <h2 id="获取存储桶名称和所属地域"><a href="#获取存储桶名称和所属地域" aria-hidden="true" class="header-anchor">#</a> 获取存储桶名称和所属地域</h2> <blockquote><p><a href="https://console.cloud.tencent.com/cos5/bucket" target="_blank" rel="noopener noreferrer">存储桶列表<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p><img src="/assets/img/get-bucket-name-and-region-name.f0788261.png" alt="获取存储桶名称和所属地域"></p> <ul><li>存储桶名称 - Bucket</li> <li>所属地域 - Region</li></ul> <h2 id="获取-secretid-和-secretkey"><a href="#获取-secretid-和-secretkey" aria-hidden="true" class="header-anchor">#</a> 获取 SecretId 和 SecretKey</h2> <blockquote><p><a href="https://console.cloud.tencent.com/cam/capi" target="_blank" rel="noopener noreferrer">API密钥管理<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p><img src="/assets/img/get-SecretId-and-SecretKey.181bef73.png" alt="获取 SecretId 和 SecretKey"></p> <h2 id="编写上传脚本"><a href="#编写上传脚本" aria-hidden="true" class="header-anchor">#</a> 编写上传脚本</h2> <p>安装依赖 <code>npm i cos-nodejs-sdk-v5 -D</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/**
 * file: uploadToCDN.js
 */</span>

<span class="token keyword">const</span> <span class="token constant">COS</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cos-nodejs-sdk-v5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  SecretId<span class="token punctuation">:</span> <span class="token string">'你的SecretId'</span><span class="token punctuation">,</span>
  SecretKey<span class="token punctuation">:</span> <span class="token string">'你的SecretKey'</span><span class="token punctuation">,</span>
  Bucket<span class="token punctuation">:</span> <span class="token string">'存储桶的名称'</span><span class="token punctuation">,</span>
  Region<span class="token punctuation">:</span> <span class="token string">'存储桶的所属地域'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// web 打包后的路径（相对地址或绝对地址都行）</span>
<span class="token comment">// uploadToCDN.js 放在根目录下了，所以这里直接使用了相对路径</span>
<span class="token keyword">const</span> webDistPath <span class="token operator">=</span> <span class="token string">'./dist/static'</span><span class="token punctuation">;</span>

<span class="token comment">// 创建实例</span>
<span class="token keyword">const</span> cos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">COS</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  SecretId<span class="token punctuation">:</span> config<span class="token punctuation">.</span>SecretId<span class="token punctuation">,</span>
  SecretKey<span class="token punctuation">:</span> config<span class="token punctuation">.</span>SecretKey<span class="token punctuation">,</span>
  <span class="token comment">// 可选参数</span>
  FileParallelLimit<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 控制文件上传并发数</span>
  ChunkParallelLimit<span class="token punctuation">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 控制单个文件下分片上传并发数，在同园区上传可以设置较大的并发数</span>
  ChunkSize<span class="token punctuation">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">// 控制分片大小，单位 B，在同园区上传可以设置较大的分片大小</span>
  Proxy<span class="token punctuation">:</span> <span class="token string">''</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> fileList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 1. 获取 bucket 中的所有文件列表</span>
<span class="token keyword">function</span> <span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cos<span class="token punctuation">.</span><span class="token function">getBucket</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      Bucket<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
      Region<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Region
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      fileList <span class="token operator">=</span> data<span class="token punctuation">.</span>Contents<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> Key<span class="token punctuation">:</span> item<span class="token punctuation">.</span>Key <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">deleteMultipleObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 2. 批量删除多个文件</span>
<span class="token keyword">function</span> <span class="token function">deleteMultipleObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fileList<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'没有文件，不需要删除'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cos<span class="token punctuation">.</span><span class="token function">deleteMultipleObject</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span>
      Bucket<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
      Region<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
      Objects<span class="token punctuation">:</span> fileList
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err <span class="token operator">||</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'删除成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 上传新的文件</span>
        <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 3. 获取打包后新的文件列表</span>
<span class="token keyword">function</span> <span class="token function">getNewFiles</span><span class="token punctuation">(</span><span class="token parameter">dir <span class="token operator">=</span> webDistPath</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> list <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
  list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> relativePath <span class="token operator">=</span> dir <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> item<span class="token punctuation">;</span>
    <span class="token keyword">const</span> absolutePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> stat <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat <span class="token operator">&amp;&amp;</span> stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      results <span class="token operator">=</span> results<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">getNewFiles</span><span class="token punctuation">(</span>relativePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        relativePath<span class="token punctuation">,</span>
        absolutePath
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> results<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 4. 文件夹内的文件批量上传至 bucket 中</span>
<span class="token keyword">function</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newFileList <span class="token operator">=</span> <span class="token function">getNewFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newFileList<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">let</span> fileLength <span class="token operator">=</span> newFileList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

  newFileList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">file</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    cos<span class="token punctuation">.</span><span class="token function">putObject</span><span class="token punctuation">(</span>
      <span class="token punctuation">{</span>
        Bucket<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Bucket<span class="token punctuation">,</span>
        Region<span class="token punctuation">:</span> config<span class="token punctuation">.</span>Region<span class="token punctuation">,</span>
        Key<span class="token punctuation">:</span> file<span class="token punctuation">.</span>relativePath<span class="token punctuation">,</span>
        <span class="token comment">// 格式1. 传入文件内容</span>
        <span class="token comment">// Body: fs.readFileSync(filepath),</span>
        <span class="token comment">// 格式2. 传入文件流，必须需要传文件大小</span>
        Body<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">,</span>
        ContentLength<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>absolutePath<span class="token punctuation">)</span><span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        SliceSize<span class="token punctuation">:</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onProgress</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">info</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> percent <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>percent <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>
          <span class="token keyword">var</span> speed <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>speed <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进度：'</span> <span class="token operator">+</span> percent <span class="token operator">+</span> <span class="token string">'%; 速度：'</span> <span class="token operator">+</span> speed <span class="token operator">+</span> <span class="token string">'Mb/s;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">onFileFinish</span><span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>Key <span class="token operator">+</span> <span class="token string">' 上传'</span> <span class="token operator">+</span> <span class="token punctuation">(</span>err <span class="token operator">?</span> <span class="token string">'失败'</span> <span class="token punctuation">:</span> <span class="token string">'完成'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err <span class="token operator">||</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          fileLength<span class="token operator">--</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">剩余</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>fileLength<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">个文件</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fileLength <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤❤❤❤❤❤❤❤❤❤❤❤'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'✅ 全部上传完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'❤❤❤❤❤❤❤❤❤❤❤❤'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="修改-package-json"><a href="#修改-package-json" aria-hidden="true" class="header-anchor">#</a> 修改 <code>package.json</code></h2> <p>安装依赖 <code>npm i cross-env -D</code></p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  ...
  <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env APP_TYPE=production node build/build.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;build-test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env APP_TYPE=test node build/build.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;cdn&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node uploadToCDN.js&quot;</span><span class="token punctuation">,</span>
  ...
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="修改-assetspublicpath"><a href="#修改-assetspublicpath" aria-hidden="true" class="header-anchor">#</a> 修改 <code>assetsPublicPath</code></h2> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">let</span> assetsPublicPath <span class="token operator">=</span> <span class="token string">'/'</span>
<span class="token comment">// 测试环境下，使用CDN</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_TYPE</span> <span class="token operator">===</span> <span class="token string">'test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  assetsPublicPath <span class="token operator">=</span> <span class="token string">'https://*****************.myqcloud.com/dist/'</span>
<span class="token punctuation">}</span>

build<span class="token punctuation">:</span> <span class="token punctuation">{</span>
  env<span class="token punctuation">:</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./prod.env'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  index<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  assetsRoot<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  assetsSubDirectory<span class="token punctuation">:</span> <span class="token string">'static'</span><span class="token punctuation">,</span>
  assetsPublicPath<span class="token punctuation">,</span>
  productionSourceMap<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">// Gzip off by default as many popular static hosts such as</span>
  <span class="token operator">/</span><span class="token operator">/</span> Surge or Netlify already gzip all <span class="token keyword">static</span> assets <span class="token keyword">for</span> you<span class="token punctuation">.</span>
  <span class="token operator">/</span><span class="token operator">/</span> Before setting to <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">true</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> make sure to<span class="token punctuation">:</span>
  <span class="token operator">/</span><span class="token operator">/</span> npm install <span class="token operator">--</span>save<span class="token operator">-</span>dev compression<span class="token operator">-</span>webpack<span class="token operator">-</span>plugin
  productionGzip<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  productionGzipExtensions<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'js'</span><span class="token punctuation">,</span> <span class="token string">'css'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token operator">/</span><span class="token operator">/</span> Run the build command <span class="token keyword">with</span> an extra argument to
  <span class="token operator">/</span><span class="token operator">/</span> View the bundle analyzer report after build finishes<span class="token punctuation">:</span>
  <span class="token operator">/</span><span class="token operator">/</span> `npm run build <span class="token operator">--</span>report`
  <span class="token operator">/</span><span class="token operator">/</span> Set to `<span class="token boolean">true</span>` or `<span class="token boolean">false</span>` to always turn it on or off
  bundleAnalyzerReport<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_report
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="修改-webpack-构建脚本"><a href="#修改-webpack-构建脚本" aria-hidden="true" class="header-anchor">#</a> 修改 webpack 构建脚本</h2> <p><code>build/build.js</code></p> <div class="language-javascript extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-javascript"><code><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./check-versions'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">=</span> <span class="token string">'production'</span>

<span class="token keyword">var</span> ora <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ora'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> rm <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'rimraf'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> chalk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'chalk'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> config <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.prod.conf'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> spinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span><span class="token string">'building for production...'</span><span class="token punctuation">)</span>
spinner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">exec</span> <span class="token punctuation">(</span><span class="token parameter">cmd</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execSync</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">rm</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>assetsRoot<span class="token punctuation">,</span> config<span class="token punctuation">.</span>build<span class="token punctuation">.</span>assetsSubDirectory<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
  <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stats</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    spinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
    process<span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      colors<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      modules<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      chunks<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      chunkModules<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n\n'</span><span class="token punctuation">)</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'  Build complete.\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">yellow</span><span class="token punctuation">(</span>
      <span class="token string">'  Tip: built files are meant to be served over an HTTP server.\n'</span> <span class="token operator">+</span>
      <span class="token string">'  Opening index.html over file:// won\'t work.\n'</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">APP_TYPE</span> <span class="token operator">!==</span> <span class="token string">'test'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 上传cdn</span>
    <span class="token keyword">const</span> uplaodSpinner <span class="token operator">=</span> <span class="token function">ora</span><span class="token punctuation">(</span><span class="token string">'upload file ...'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'  Start upload file to Tencent bucket.\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    uplaodSpinner<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 执行上传脚本</span>
    <span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">'npm run cdn'</span><span class="token punctuation">)</span>
    
    uplaodSpinner<span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token function">cyan</span><span class="token punctuation">(</span><span class="token string">'  upload complete.\n'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="done"><a href="#done" aria-hidden="true" class="header-anchor">#</a> Done!</h2> <ul><li>构建生成环境：<code>npm run build</code></li> <li>构建测试环境：<code>npm run build-test</code></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Anonymity94/Anonymity94.github.io/edit/v2/articles/upload-files-to-tencent-cos/README.md" target="_blank" rel="noopener noreferrer">发现错误？在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/19/2020, 5:47:53 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c731b61c.js" defer></script><script src="/assets/js/2.7021f184.js" defer></script><script src="/assets/js/18.12e20ca7.js" defer></script><script src="/assets/js/12.36288b32.js" defer></script>
  </body>
</html>
