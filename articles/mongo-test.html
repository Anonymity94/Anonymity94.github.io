<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mongo副本集 | Anonymity94</title>
    <meta name="description" content="Just do IT.">
    <link rel="icon" href="/avatar.png">
  <meta author="anonymity94">
    
    <link rel="preload" href="/assets/css/0.styles.78cb79ba.css" as="style"><link rel="preload" href="/assets/js/app.68259121.js" as="script"><link rel="preload" href="/assets/js/2.7021f184.js" as="script"><link rel="preload" href="/assets/js/36.9a7888ad.js" as="script"><link rel="preload" href="/assets/js/12.36288b32.js" as="script"><link rel="prefetch" href="/assets/js/10.2aa202b8.js"><link rel="prefetch" href="/assets/js/11.94323dc4.js"><link rel="prefetch" href="/assets/js/13.446a861d.js"><link rel="prefetch" href="/assets/js/14.2a28af99.js"><link rel="prefetch" href="/assets/js/15.929c061b.js"><link rel="prefetch" href="/assets/js/16.b186e3a6.js"><link rel="prefetch" href="/assets/js/17.ca8543d1.js"><link rel="prefetch" href="/assets/js/18.12e20ca7.js"><link rel="prefetch" href="/assets/js/19.1bdc835b.js"><link rel="prefetch" href="/assets/js/20.0110c185.js"><link rel="prefetch" href="/assets/js/21.c2358486.js"><link rel="prefetch" href="/assets/js/22.1604085f.js"><link rel="prefetch" href="/assets/js/23.c4155c42.js"><link rel="prefetch" href="/assets/js/24.2ee4a564.js"><link rel="prefetch" href="/assets/js/25.2216b279.js"><link rel="prefetch" href="/assets/js/26.f3f9b536.js"><link rel="prefetch" href="/assets/js/27.f3be5151.js"><link rel="prefetch" href="/assets/js/28.99bc744c.js"><link rel="prefetch" href="/assets/js/29.16ad8838.js"><link rel="prefetch" href="/assets/js/3.62a069da.js"><link rel="prefetch" href="/assets/js/30.07e23d36.js"><link rel="prefetch" href="/assets/js/31.816c7346.js"><link rel="prefetch" href="/assets/js/32.34a8e342.js"><link rel="prefetch" href="/assets/js/33.eddd3d1a.js"><link rel="prefetch" href="/assets/js/34.e6792a3d.js"><link rel="prefetch" href="/assets/js/35.61f55c81.js"><link rel="prefetch" href="/assets/js/37.34c83d09.js"><link rel="prefetch" href="/assets/js/38.79c435b2.js"><link rel="prefetch" href="/assets/js/39.e83ac360.js"><link rel="prefetch" href="/assets/js/4.9be7231c.js"><link rel="prefetch" href="/assets/js/40.b8783bac.js"><link rel="prefetch" href="/assets/js/5.4c660a59.js"><link rel="prefetch" href="/assets/js/6.2a5b040a.js"><link rel="prefetch" href="/assets/js/7.f9c12c03.js"><link rel="prefetch" href="/assets/js/8.c7d52026.js"><link rel="prefetch" href="/assets/js/9.866a33ab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.78cb79ba.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Anonymity94</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/collections/" class="nav-link">收藏夹</a></div><div class="nav-item"><a href="/archive/" class="nav-link">归档</a></div><div class="nav-item"><a href="/experimentation/" class="nav-link">试验场</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/Anonymity94" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">文章</a></div><div class="nav-item"><a href="/collections/" class="nav-link">收藏夹</a></div><div class="nav-item"><a href="/archive/" class="nav-link">归档</a></div><div class="nav-item"><a href="/experimentation/" class="nav-link">试验场</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div> <a href="https://github.com/Anonymity94" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mongo副本集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/mongo-test.html#添加-yum-源" class="sidebar-link">添加 yum 源</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#查看安装的位置" class="sidebar-link">查看安装的位置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#每台服务器建立副本集测试文件夹" class="sidebar-link">每台服务器建立副本集测试文件夹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#修改配置文件" class="sidebar-link">修改配置文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#每台服务器启动-mongodb" class="sidebar-link">每台服务器启动 mongodb</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#初始化副本集" class="sidebar-link">初始化副本集</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#查看副本集状态" class="sidebar-link">查看副本集状态</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主2备：只停掉主节点" class="sidebar-link">1主2备：只停掉主节点</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主2备：停掉2个节点" class="sidebar-link">1主2备：停掉2个节点</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主1备：停掉一个节点" class="sidebar-link">1主1备：停掉一个节点</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主1备1仲裁" class="sidebar-link">1主1备1仲裁</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主1备3仲裁" class="sidebar-link">1主1备3仲裁</a></li></ul></li><li><a href="/articles/mongo-test.html#附录" class="sidebar-link">附录</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mongo副本集"><a href="#mongo副本集" aria-hidden="true" class="header-anchor">#</a> Mongo副本集</h1> <div class="post-meta" data-v-7b3ac6b7><span class="post-time" data-v-7b3ac6b7><span class="post-meta-item-text" data-v-7b3ac6b7>
      发布于:
    </span> <time itemprop="dateCreated" datetime="2019-05-08T06:23:53.000Z" data-v-7b3ac6b7>
      2019-05-08
    </time></span> <div class="post-category" data-v-7b3ac6b7><span itemprop="tag" data-v-7b3ac6b7><a href="/archive/?tag=mongo" data-v-7b3ac6b7><span class="tag sm" data-v-7b3ac6b7>
          mongo
        </span></a></span></div></div> <blockquote><p>安装参考：
<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/" target="_blank" rel="noopener noreferrer">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <blockquote><p>测试服务器</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>10.0.0.155
10.0.0.156
10.0.0.157
</code></pre></div><h2 id="添加-yum-源"><a href="#添加-yum-源" aria-hidden="true" class="header-anchor">#</a> 添加 <code>yum</code> 源</h2> <p>Configure the package management system (yum).
Create a <code>/etc/yum.repos.d/mongodb-org-4.0.repo</code> file so that you can install MongoDB directly using yum:</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>mongodb-org-4.0<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>MongoDB Repository
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://repo.mongodb.org/yum/redhat/<span class="token variable">$releasever</span>/mongodb-org/4.0/x86_64/
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://www.mongodb.org/static/pgp/server-4.0.asc
</code></pre></div><h2 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> -y mongodb-org
</code></pre></div><h2 id="查看安装的位置"><a href="#查看安装的位置" aria-hidden="true" class="header-anchor">#</a> 查看安装的位置</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># whereis mongod</span>
mongod: /usr/bin/mongod /etc/mongod.conf /usr/share/man/man1/mongod.1
</code></pre></div><h2 id="每台服务器建立副本集测试文件夹"><a href="#每台服务器建立副本集测试文件夹" aria-hidden="true" class="header-anchor">#</a> 每台服务器建立副本集测试文件夹</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#存放整个mongodb文件</span>
<span class="token function">mkdir</span> -p /data/mongodbtest/replset

<span class="token comment"># 配置文件</span>
<span class="token function">touch</span> /data/mongodbtest/replset/mongod.conf
 
<span class="token comment"># 存放mongodb数据文件</span>
<span class="token function">mkdir</span> -p /data/mongodbtest/replset/data

<span class="token comment"># 存放mongodb日志文件</span>
<span class="token function">mkdir</span> -p /data/mongodbtest/replset/log
<span class="token function">touch</span> /data/mongodbtest/replset/log/mongodbtest.log
 
</code></pre></div><h2 id="修改配置文件"><a href="#修改配置文件" aria-hidden="true" class="header-anchor">#</a> 修改配置文件</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># mongod.conf</span>

<span class="token comment"># for documentation of all options, see:</span>
<span class="token comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span>

<span class="token comment"># where to write logging data.</span>
systemLog:
  destination: <span class="token function">file</span>
  logAppend: <span class="token boolean">true</span>
  path: /data/mongodbtest/replset/log/mongodbtest.log <span class="token comment"># 日志位置</span>

<span class="token comment"># Where and how to store data.</span>
storage:
  dbPath: /data/mongodbtest/replset/data <span class="token comment"># 数据库数据文件</span>
  journal:
    enabled: <span class="token boolean">true</span>
<span class="token comment">#  engine:</span>
<span class="token comment">#  mmapv1:</span>
<span class="token comment">#  wiredTiger:</span>

<span class="token comment"># how the process runs</span>
processManagement:
  fork: <span class="token boolean">true</span>  <span class="token comment"># fork and run in background</span>
  pidFilePath: /var/run/mongodb/mongod.pid  <span class="token comment"># location of pidfile</span>
  timeZoneInfo: /usr/share/zoneinfo

<span class="token comment"># network interfaces</span>
net:
  port: <span class="token number">27017</span>
  bindIp: <span class="token number">127.0</span>.0.1  <span class="token comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span>


<span class="token comment">#security:</span>

<span class="token comment">#operationProfiling:</span>
replication:
    replSetName: replset <span class="token comment"># 副本集名称</span>

<span class="token comment">#sharding:</span>

<span class="token comment">## Enterprise-Only Options</span>

<span class="token comment">#auditLog:</span>

<span class="token comment">#snmp:</span>
</code></pre></div><h2 id="每台服务器启动-mongodb"><a href="#每台服务器启动-mongodb" aria-hidden="true" class="header-anchor">#</a> 每台服务器启动 <code>mongodb</code></h2> <div class="language- extra-class"><pre class="language-text"><code># 启动服务
$ /usr/bin/mongod -f /data/mongodbtest/replset/mongod.conf

# 停止服务
$ use admin
$ db.shutdownServer()
</code></pre></div><h2 id="初始化副本集"><a href="#初始化副本集" aria-hidden="true" class="header-anchor">#</a> 初始化副本集</h2> <blockquote><p><a href="https://www.cnblogs.com/ljai/p/4898475.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/ljai/p/4898475.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>$ mongo
<span class="token operator">&gt;</span> use admin
<span class="token comment"># 定义副本集配置</span>
<span class="token comment"># 键“_id”对应的值必须与配置文件中的replicaction.replSetName一致</span>
<span class="token comment"># priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器</span>
<span class="token comment"># arbiterOnly:true 代表其为仲裁节点</span>

<span class="token comment"># 初始化副本集配置</span>
<span class="token operator">&gt;</span> rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 查看设置</span>
<span class="token operator">&gt;</span> rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 添加节点</span>
<span class="token operator">&gt;</span> rs.add<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.156:27017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> rs.add<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.157:27017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 查看状态</span>
<span class="token operator">&gt;</span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 出问题的话可以重置配置，副本集重置</span>
<span class="token operator">&gt;</span> <span class="token assign-left variable">conf</span><span class="token operator">=</span>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> conf.members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.host<span class="token operator">=</span><span class="token string">&quot;10.0.0.155:27017&quot;</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> rs.reconfig<span class="token punctuation">(</span>conf,<span class="token punctuation">{</span><span class="token string">&quot;force&quot;</span>:true<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><h2 id="查看副本集状态"><a href="#查看副本集状态" aria-hidden="true" class="header-anchor">#</a> 查看副本集状态</h2> <div class="language-bash extra-class"><pre class="language-bash"><code>replset:PRIMARY<span class="token operator">&gt;</span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;replset&quot;</span>,
	<span class="token string">&quot;date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:43.540Z&quot;</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;myState&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
	<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;optimes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;lastCommittedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;readConcernMajorityOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;appliedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;durableOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>,
	<span class="token string">&quot;lastStableCheckpointTimestamp&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737423</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.155:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>, <span class="token comment"># 主节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">714</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;electionTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550736771</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;electionDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:12:51Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91697</span>,
			<span class="token string">&quot;self&quot;</span> <span class="token builtin class-name">:</span> true,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>, <span class="token comment"># 副本节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">11</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:41.964Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:42.982Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91697</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.157:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>, <span class="token comment"># 副本节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:41.963Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:42.789Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91697</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;operationTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;<span class="token variable">$clusterTime</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;clusterTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
		<span class="token string">&quot;signature&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;hash&quot;</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;keyId&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h1 id="测试数据同步"><a href="#测试数据同步" aria-hidden="true" class="header-anchor">#</a> 测试数据同步</h1> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试一，PRIMARY(1)上写数据，然后关闭PRIMARY（1）</span>
<span class="token comment">#  从新的PRIMARY（2）主机上查看，看数据是否同步</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 1.1 进入 10.0.0.155</span>
$ mongo

$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">26</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 输出 WriteResult({ &quot;nInserted&quot; : 1 })</span>

$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">23</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 输出 WriteResult({ &quot;nInserted&quot; : 1 })</span>

<span class="token comment"># 1.2 查看插入到 155 的数据</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>

<span class="token comment"># 1.3 停掉155数据库，连接156数据库,查看状态发现156 变成了PRIMARY</span>
$ mongo
<span class="token operator">&gt;</span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 1.4 156上查询数据，发现数据已经同步过来了</span>
<span class="token operator">&gt;</span> db.person.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>

<span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试二，在PRIMARY(2) 上写数据，然后关闭PRIMARY(2)</span>
<span class="token comment">#  观察PRIMARY(1)是否会重新恢复成PRIMARY</span>
<span class="token comment">#  观察PRIMARY(2)上写的数据是否会同步到PRIMARY(1)上</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 2.1 156上插入新数据</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 输出 WriteResult({ &quot;nInserted&quot; : 1 })</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e690375369bb4020815d7&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>

<span class="token comment"># 2.2 启动155数据库，关闭156数据库，发现155数据库回重新变成在PRIMARY身份</span>
<span class="token comment"># 2.3 进入155数据库，查询，发现156上新增的数据也被同步过来了</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e690375369bb4020815d7&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>

<span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试三，写入大量数据，观察数据同步是否成功</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 3.1 155上新建一个集合 peopleTest-155</span>
<span class="token comment"># 3.2 执行写库脚本,写入 100W 条数据</span>
$ node index.js
<span class="token comment"># 3.3 关闭155数据库</span>
<span class="token comment"># 3.4 去156查看副本集状态，发现157变成主节点</span>
$ rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 3.5 去157上查看数据状态</span>
$ use person <span class="token comment"># 切换到person库</span>
$ show tables <span class="token comment"># 展示所有的集合</span>
<span class="token comment"># 输出</span>
<span class="token comment"># people</span>
<span class="token comment"># peopleTest-155</span>
<span class="token comment"># 3.6 查询数据是否同步过来了</span>
$ db.peopleTest.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.count<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 输出</span>
<span class="token comment"># 1000000</span>
<span class="token comment"># 结论：155 上写的数据已经被成功同步到了157上</span>

<span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试四，三个节点，1主2备，关闭2个节点，观察是否还可用</span>
<span class="token comment">#  结果：3个节点 =&gt; 2个节点(可用) =&gt; 1个节点(不可用)</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 4.1</span>
<span class="token comment"># </span>
</code></pre></div><h3 id="_1主2备：只停掉主节点"><a href="#_1主2备：只停掉主节点" aria-hidden="true" class="header-anchor">#</a> 1主2备：只停掉主节点</h3> <p>测试结果：<strong>正常</strong></p> <p>2个 <code>Secondary</code> 中会选出来一个 <code>PRIMARY</code></p> <h3 id="_1主2备：停掉2个节点"><a href="#_1主2备：停掉2个节点" aria-hidden="true" class="header-anchor">#</a> 1主2备：停掉2个节点</h3> <p>测试结果：<strong>无法提供服务</strong></p> <p><u>测试1：依次停掉主、从节点</u></p> <p>① 先停掉 <code>PRIMARY</code>，2个 <code>SECONDARY</code> 中会选出来一个 <code>PRIMARY</code> 。<strong>正常</strong></p> <p>② 再停掉一个 <code>SECONDARY</code>，<code>PRIMARY</code> 最终会变成 <code>SECONDARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试2：依次停掉从、主节点</u></p> <p>① 先停掉一个 <code>SECONDARY</code>。<strong>正常</strong></p> <p>② 再停掉 <code>PRIMARY</code>，剩余的一个 <code>SECONDARY</code> 不会变成 <code>PRIMARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试3：停掉2个从节点</u></p> <p>① 先停掉一个 <code>SECONDARY</code>。<strong>正常</strong></p> <p>② 再停掉一个 <code>SECONDARY</code>，<code>PRIMARY</code> 最终会变成 <code>SECONDARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <h3 id="_1主1备：停掉一个节点"><a href="#_1主1备：停掉一个节点" aria-hidden="true" class="header-anchor">#</a> 1主1备：停掉一个节点</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 在3个节点的情况下，移除 10.0.0.155</span>
$ rs.remove<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.155:27017&quot;</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span> <span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token comment"># 剩余2个节点，1主1备</span>
<span class="token comment"># 10.0.0.156 SECONDARY</span>
<span class="token comment"># 10.0.0.157 PRIMARY</span>
</code></pre></div><p><u>测试1：</u>停掉 <code>PRIMARY</code>，<code>SECONDARY</code> 不会变成 <code>PRIMARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试2：</u>停掉 <code>SECONDARY</code>，<code>PRIMARY</code> 最终会变成 <code>SECONDARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <h3 id="_1主1备1仲裁"><a href="#_1主1备1仲裁" aria-hidden="true" class="header-anchor">#</a> 1主1备1仲裁</h3> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 在1主1备2个节点的情况下，添加一个仲裁节点</span>
<span class="token comment"># 仲裁节点，监控其他节点状态，参与选主投票，不参与数据保存</span>
<span class="token comment"># 方法一</span>
$ rs.add<span class="token punctuation">(</span><span class="token punctuation">{</span>host:<span class="token string">&quot;10.0.0.155:27017&quot;</span>,arbiterOnly:true<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 或方法二</span>
$ rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.155:27017&quot;</span><span class="token punctuation">)</span>
$ rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.101:27017&quot;</span><span class="token punctuation">)</span>
$ rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.102:27017&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># 查看是否添加成功</span>
$ replset:ARBITER<span class="token operator">&gt;</span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;replset&quot;</span>,
	<span class="token string">&quot;date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:53.717Z&quot;</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;myState&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,
	<span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
	<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;optimes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;lastCommittedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;readConcernMajorityOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;appliedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;durableOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>,
	<span class="token string">&quot;lastStableCheckpointTimestamp&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081735</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>,
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">149</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:52.755Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:53.322Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;electionTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081143</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;electionDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T07:52:23Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91701</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.157:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>,
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">149</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:52.754Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:53.337Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91701</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.155:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ARBITER&quot;</span>, <span class="token comment"># 仲裁节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">151</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91701</span>,
			<span class="token string">&quot;self&quot;</span> <span class="token builtin class-name">:</span> true,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre></div><p><u>测试1：</u>停掉 <code>PRIMARY</code>，<code>SECONDARY</code> 会自动变成 <code>PRIMARY</code>。<strong>正常</strong></p> <p><u>测试2：</u>停掉 <code>SECONDARY</code>，<code>PRIMARY</code> 保持主节点的状态。<strong>正常</strong></p> <p><u>测试3：</u>停掉 <code>ARBITER</code>。<strong>正常</strong></p> <h3 id="_1主1备3仲裁"><a href="#_1主1备3仲裁" aria-hidden="true" class="header-anchor">#</a> 1主1备3仲裁</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># 初始情况：</span>
<span class="token number">10.0</span>.0.155 仲裁节点
<span class="token number">10.0</span>.0.156 主节点
<span class="token number">10.0</span>.0.157 副本节点
<span class="token number">10.0</span>.0.101 仲裁节点
<span class="token number">10.0</span>.0.102 仲裁节点
</code></pre></div><p><u>测试1：</u><strong>（结论：停掉2个仲裁节点就不行了）</strong></p> <p>① 先停掉主节点，副本节点会自动变成主节点。<strong>正常</strong></p> <p>② 再停掉一个仲裁节点（10.0.0.155）。<strong>正常</strong></p> <p>③ 再停掉一个仲裁节点（10.0.0.101），主节点会变成副本节点。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试2：</u><strong>（结论：停掉2个仲裁节点就不行了）</strong></p> <p>① 先停掉副本节点，主节点保持不变。<strong>正常</strong></p> <p>② 再停掉一个仲裁节点（10.0.0.155）。<strong>正常</strong></p> <p>③ 再停掉一个仲裁节点（10.0.0.101），主节点会变成副本节点。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试3：</u><strong>（结论：停掉2个仲裁节点就不行了）</strong></p> <p>① 先停掉1个仲裁节点（10.0.0.155）。<strong>正常</strong></p> <p>② 再停掉1个仲裁节点（10.0.0.101）。主节点服务器会直接down掉，退出ssh连接。</p> <p>再次启动主节点mongo时会报错：由于异常退出数据库导致的错误。<strong>异常</strong></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost data<span class="token punctuation">]</span><span class="token comment"># /usr/bin/mongod -f /data/mongodbtest/replset/mongod.conf</span>
about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.
forked process: <span class="token number">2041</span>
ERROR: child process failed, exited with error number <span class="token number">48</span>
To see additional information <span class="token keyword">in</span> this output, start without the <span class="token string">&quot;--fork&quot;</span> option.
</code></pre></div><h2 id="附录"><a href="#附录" aria-hidden="true" class="header-anchor">#</a> 附录</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * file：index.js
 * 
 * npm i
 * node index.js
*/</span>

<span class="token string">'use strict'</span>

<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> async <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async'</span><span class="token punctuation">)</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://10.0.0.156:27017/person'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> con <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>connection

<span class="token comment">// 随机生成字符串</span>
<span class="token keyword">function</span> <span class="token function">randomString</span><span class="token punctuation">(</span>
  length<span class="token punctuation">,</span>
  chars <span class="token operator">=</span> <span class="token string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> length<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span>
    result <span class="token operator">+=</span> chars<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> chars<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 写入的 Collection</span>
<span class="token keyword">const</span> <span class="token constant">COLLECTION</span> <span class="token operator">=</span> <span class="token string">'peopleTest-156'</span>
<span class="token comment">// 写入数据的总条数</span>
<span class="token keyword">const</span> <span class="token constant">TOTAL</span> <span class="token operator">=</span> <span class="token number">1000000</span>
<span class="token comment">// 并发控制，每次批量写1万条</span>
<span class="token keyword">const</span> <span class="token constant">LIMIT</span> <span class="token operator">=</span> <span class="token number">10000</span>

con<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> <span class="token string">'连接数据库失败'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
con<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> String<span class="token punctuation">,</span> age<span class="token punctuation">:</span> Number <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 第三个参数，为实际的 collection 的名字，避免自动转复数</span>
  <span class="token keyword">const</span> personModel <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token constant">COLLECTION</span><span class="token punctuation">,</span> schema<span class="token punctuation">,</span> <span class="token constant">COLLECTION</span><span class="token punctuation">)</span>

  <span class="token comment">// 每1万数据归为1组</span>
  <span class="token keyword">let</span> peopleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">TOTAL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token constant">LIMIT</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peopleArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> peopleArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    peopleArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">person_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      age<span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">99</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 控制并发，每次写1组数据（1W条），写完再写下一组</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  async<span class="token punctuation">.</span><span class="token function">mapLimit</span><span class="token punctuation">(</span>
    peopleArr<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> time1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 批量写</span>
      personModel<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> docs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> err
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">组，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        index<span class="token operator">++</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'==========='</span><span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> docs<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TOTAL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">条数据写入完成，总耗时:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Anonymity94/Anonymity94.github.io/edit/v2/articles/mongo-test.md" target="_blank" rel="noopener noreferrer">发现错误？在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">5/15/2020, 2:09:36 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.68259121.js" defer></script><script src="/assets/js/2.7021f184.js" defer></script><script src="/assets/js/36.9a7888ad.js" defer></script><script src="/assets/js/12.36288b32.js" defer></script>
  </body>
</html>
