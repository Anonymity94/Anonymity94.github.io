<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Mongo副本集 | Anonymity94</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/avatar.png">
    <meta name="description" content="Just do IT.">
    <meta author="anonymity94">
    
    <link rel="preload" href="/assets/css/0.styles.5ce11312.css" as="style"><link rel="preload" href="/assets/js/app.f17bcff4.js" as="script"><link rel="preload" href="/assets/js/2.8e2eb0cc.js" as="script"><link rel="preload" href="/assets/js/16.7f69dad5.js" as="script"><link rel="preload" href="/assets/js/54.8f75818d.js" as="script"><link rel="prefetch" href="/assets/js/10.2d357a0e.js"><link rel="prefetch" href="/assets/js/11.14aad5dd.js"><link rel="prefetch" href="/assets/js/12.c886564c.js"><link rel="prefetch" href="/assets/js/13.bba3a565.js"><link rel="prefetch" href="/assets/js/14.9790ae9b.js"><link rel="prefetch" href="/assets/js/15.d8e245cd.js"><link rel="prefetch" href="/assets/js/17.2b8644a2.js"><link rel="prefetch" href="/assets/js/18.1eafe3b9.js"><link rel="prefetch" href="/assets/js/19.f186112b.js"><link rel="prefetch" href="/assets/js/20.43b9e2bc.js"><link rel="prefetch" href="/assets/js/21.fb1cc76a.js"><link rel="prefetch" href="/assets/js/22.6d39a5e2.js"><link rel="prefetch" href="/assets/js/23.6cef3c60.js"><link rel="prefetch" href="/assets/js/24.c657929a.js"><link rel="prefetch" href="/assets/js/25.65d8b5aa.js"><link rel="prefetch" href="/assets/js/26.fc95d6ba.js"><link rel="prefetch" href="/assets/js/27.12f888ca.js"><link rel="prefetch" href="/assets/js/28.b5aac387.js"><link rel="prefetch" href="/assets/js/29.6dc517b4.js"><link rel="prefetch" href="/assets/js/3.012d1ccb.js"><link rel="prefetch" href="/assets/js/30.07d91df8.js"><link rel="prefetch" href="/assets/js/31.64710a8f.js"><link rel="prefetch" href="/assets/js/32.577f5366.js"><link rel="prefetch" href="/assets/js/33.1d2230ad.js"><link rel="prefetch" href="/assets/js/34.5c7f059a.js"><link rel="prefetch" href="/assets/js/35.c6b95704.js"><link rel="prefetch" href="/assets/js/36.5138e81a.js"><link rel="prefetch" href="/assets/js/37.a036292c.js"><link rel="prefetch" href="/assets/js/38.fd73c79c.js"><link rel="prefetch" href="/assets/js/39.450add42.js"><link rel="prefetch" href="/assets/js/4.1f193a26.js"><link rel="prefetch" href="/assets/js/40.c312d9ce.js"><link rel="prefetch" href="/assets/js/41.5436f882.js"><link rel="prefetch" href="/assets/js/42.dbeede21.js"><link rel="prefetch" href="/assets/js/43.3e5f3f30.js"><link rel="prefetch" href="/assets/js/44.b609441e.js"><link rel="prefetch" href="/assets/js/45.86459b11.js"><link rel="prefetch" href="/assets/js/46.f1042ab1.js"><link rel="prefetch" href="/assets/js/47.3ad5df71.js"><link rel="prefetch" href="/assets/js/48.481ac1e8.js"><link rel="prefetch" href="/assets/js/49.614c5d66.js"><link rel="prefetch" href="/assets/js/5.a621b481.js"><link rel="prefetch" href="/assets/js/50.0a9d3219.js"><link rel="prefetch" href="/assets/js/51.86ebe0e6.js"><link rel="prefetch" href="/assets/js/52.b3bcc7c4.js"><link rel="prefetch" href="/assets/js/53.68ecb31c.js"><link rel="prefetch" href="/assets/js/55.cce8987a.js"><link rel="prefetch" href="/assets/js/56.0e3defd6.js"><link rel="prefetch" href="/assets/js/57.f2afcc59.js"><link rel="prefetch" href="/assets/js/58.36557542.js"><link rel="prefetch" href="/assets/js/59.806b2708.js"><link rel="prefetch" href="/assets/js/6.b4481962.js"><link rel="prefetch" href="/assets/js/60.78a47113.js"><link rel="prefetch" href="/assets/js/61.68b47e4b.js"><link rel="prefetch" href="/assets/js/62.db99ef98.js"><link rel="prefetch" href="/assets/js/63.f7dae60c.js"><link rel="prefetch" href="/assets/js/64.29069c30.js"><link rel="prefetch" href="/assets/js/65.3a6950e8.js"><link rel="prefetch" href="/assets/js/66.e4ea7159.js"><link rel="prefetch" href="/assets/js/7.c0177900.js"><link rel="prefetch" href="/assets/js/8.64d7158c.js"><link rel="prefetch" href="/assets/js/9.c5287bf2.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ce11312.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Anonymity94</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/collections/" class="nav-link">
  收藏夹
</a></div><div class="nav-item"><a href="/archive/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/experimentation/" class="nav-link">
  试验场
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/Anonymity94" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  文章
</a></div><div class="nav-item"><a href="/collections/" class="nav-link">
  收藏夹
</a></div><div class="nav-item"><a href="/archive/" class="nav-link">
  归档
</a></div><div class="nav-item"><a href="/experimentation/" class="nav-link">
  试验场
</a></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/Anonymity94" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Mongo副本集</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/mongo-test.html#添加-yum-源" class="sidebar-link">添加 yum 源</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#查看安装的位置" class="sidebar-link">查看安装的位置</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#每台服务器建立副本集测试文件夹" class="sidebar-link">每台服务器建立副本集测试文件夹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#修改配置文件" class="sidebar-link">修改配置文件</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#每台服务器启动-mongodb" class="sidebar-link">每台服务器启动 mongodb</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#初始化副本集" class="sidebar-link">初始化副本集</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/articles/mongo-test.html#查看副本集状态" class="sidebar-link">查看副本集状态</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主2备-只停掉主节点" class="sidebar-link">1主2备：只停掉主节点</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主2备-停掉2个节点" class="sidebar-link">1主2备：停掉2个节点</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主1备-停掉一个节点" class="sidebar-link">1主1备：停掉一个节点</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主1备1仲裁" class="sidebar-link">1主1备1仲裁</a></li><li class="sidebar-sub-header"><a href="/articles/mongo-test.html#_1主1备3仲裁" class="sidebar-link">1主1备3仲裁</a></li></ul></li><li><a href="/articles/mongo-test.html#附录" class="sidebar-link">附录</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <header class="post-meta" data-v-11fb19df><div class="post-time" data-v-11fb19df><span class="post-meta-item-text" data-v-11fb19df><svg t="1616210691351" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1173" width="20" height="20" class="icon" data-v-11fb19df><path d="M512 512m-480.0512 0a480.0512 480.0512 0 1 0 960.1024 0 480.0512 480.0512 0 1 0-960.1024 0Z" fill="#F0EEE2" p-id="1174" data-v-11fb19df></path> <path d="M512 512m-79.9744 0a79.9744 79.9744 0 1 0 159.9488 0 79.9744 79.9744 0 1 0-159.9488 0Z" fill="#BBAA9C" p-id="1175" data-v-11fb19df></path> <path d="M975.9744 576h-48.0256c-8.8064 0.2048-15.7696 7.5776-15.5648 16.384 0.2048 8.4992 7.0656 15.36 15.5648 15.5648h48.0256c8.8064-0.2048 15.7696-7.5776 15.5648-16.384-0.2048-8.4992-6.9632-15.36-15.5648-15.5648z m-655.9744 15.9744h-31.9488c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744h31.9488c8.8064 0 15.9744-7.168 15.9744-15.9744s-7.168-15.9744-15.9744-15.9744z m416.0512-143.9744h-31.9488c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744h31.9488c8.8064 0 15.9744-7.168 15.9744-15.9744s-7.168-15.9744-15.9744-15.9744zM640 640h-96.0512c-8.8064 0.2048-15.7696 7.5776-15.5648 16.384 0.2048 8.4992 7.0656 15.36 15.5648 15.5648H640c8.8064 0.2048 16.1792-6.7584 16.384-15.5648s-6.7584-16.1792-15.5648-16.384h-0.8192z m143.9744-527.9744H671.9488c-8.8064 0.2048-15.7696 7.5776-15.5648 16.384 0.2048 8.4992 7.0656 15.36 15.5648 15.5648h112.0256c8.8064 0.2048 16.1792-6.7584 16.384-15.5648s-6.7584-16.1792-15.5648-16.384h-0.8192z m-384 207.9744h-96.0512c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744h96.0512c8.8064 0 15.9744-7.168 15.9744-15.9744s-7.168-15.9744-15.9744-15.9744zM176.0256 768h-64c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744h64c8.8064 0 15.9744-7.168 15.9744-15.9744s-7.168-15.9744-15.9744-15.9744z m607.9488 0H768c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744h15.9744c8.8064 0 15.9744-7.168 15.9744-15.9744s-7.168-15.9744-15.9744-15.9744z m-335.9744 0c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744 15.9744-7.168 15.9744-15.9744-7.168-15.9744-15.9744-15.9744z" fill="#D8D5BA" p-id="1176" data-v-11fb19df></path> <path d="M512 847.9744c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744 15.9744-7.168 15.9744-15.9744-7.168-15.9744-15.9744-15.9744z m-168.0384-45.056c-7.68-4.4032-17.408-1.7408-21.8112 5.8368s-1.7408 17.408 5.8368 21.8112c7.68 4.4032 17.408 1.8432 21.8112-5.8368 4.5056-7.5776 1.8432-17.3056-5.8368-21.8112z m-15.9744-609.5872c-7.68 4.4032-10.24 14.2336-5.8368 21.8112s14.2336 10.24 21.8112 5.8368c7.68-4.4032 10.24-14.2336 5.8368-21.8112-4.4032-7.68-14.1312-10.24-21.8112-5.8368zM159.9488 496.0256c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744 15.9744-7.168 15.9744-15.9744c0.1024-8.8064-7.0656-15.9744-15.9744-15.9744z m39.2192 178.176c-7.68 4.4032-10.24 14.2336-5.8368 21.8112 4.4032 7.68 14.2336 10.24 21.8112 5.8368 7.68-4.4032 10.24-14.2336 5.8368-21.8112-4.4032-7.68-14.1312-10.3424-21.8112-5.8368z m15.9744-352.0512c-7.68-4.4032-17.408-1.7408-21.8112 5.8368-4.4032 7.68-1.7408 17.408 5.8368 21.8112 7.68 4.4032 17.408 1.8432 21.8112-5.8368 4.5056-7.5776 1.8432-17.408-5.8368-21.8112z m648.9088 173.8752c-8.8064 0-15.9744 7.168-15.9744 15.9744s7.168 15.9744 15.9744 15.9744 15.9744-7.168 15.9744-15.9744-7.168-15.9744-15.9744-15.9744z m-39.2192 178.176c-7.68-4.4032-17.408-1.7408-21.8112 5.8368-4.4032 7.68-1.7408 17.408 5.8368 21.8112 7.68 4.4032 17.408 1.8432 21.8112-5.8368 4.5056-7.68 1.8432-17.408-5.8368-21.8112 0-0.1024 0-0.1024 0 0zM512 0C229.2736 0 0 229.2736 0 512s229.2736 512 512 512 512-229.2736 512-512S794.7264 0 512 0z m0 960C264.6016 960 64 759.3984 64 512S264.6016 64 512 64 960 264.6016 960 512 759.3984 960 512 960z m186.9824-261.0176c6.2464-6.2464 6.2464-16.384 0-22.6304L590.2336 567.6032c30.72-43.2128 20.5824-103.2192-22.6304-133.9392-11.776-8.3968-25.2928-14.0288-39.6288-16.384V159.9488c0-8.8064-7.168-15.9744-15.9744-15.9744s-15.9744 7.168-15.9744 15.9744v257.3312c-52.224 8.8064-87.4496 58.368-78.6432 110.6944s58.368 87.4496 110.6944 78.6432c14.2336-2.4576 27.7504-7.9872 39.5264-16.384l108.7488 108.7488c6.2464 6.2464 16.384 6.2464 22.6304 0zM512 576c-35.328 0-64-28.672-64-64s28.672-64 64-64 64 28.672 64 64-28.672 64-64 64z m184.0128-382.6688c-7.68-4.4032-17.408-1.7408-21.8112 5.8368-4.4032 7.68-1.7408 17.408 5.8368 21.8112 7.68 4.4032 17.408 1.8432 21.8112-5.8368 4.4032-7.68 1.8432-17.408-5.8368-21.8112z m-15.9744 609.6896c-7.68 4.4032-10.24 14.2336-5.8368 21.8112 4.4032 7.68 14.2336 10.24 21.8112 5.8368 7.68-4.4032 10.24-14.2336 5.8368-21.8112-4.4032-7.68-14.2336-10.3424-21.8112-5.8368z m128.8192-480.8704c-7.68 4.4032-10.24 14.2336-5.8368 21.8112 4.4032 7.68 14.2336 10.24 21.8112 5.8368 7.68-4.4032 10.24-14.2336 5.8368-21.8112-4.4032-7.68-14.1312-10.24-21.8112-5.8368z" fill="#5F4E56" p-id="1177" data-v-11fb19df></path></svg></span> <span itemprop="dateCreated" title="发表时间" datetime="2019-05-08T06:23:53.000Z" data-v-11fb19df>
      2019-05-08
    </span></div> <div class="post-category" data-v-11fb19df><span itemprop="tag" data-v-11fb19df><a href="/archive/?tag=mongo" data-v-11fb19df><span class="tag sm" data-v-11fb19df>
          mongo
        </span></a></span></div></header> <div class="theme-default-content content__default"><h1 id="mongo副本集"><a href="#mongo副本集" class="header-anchor">#</a> Mongo副本集</h1> <blockquote><p>安装参考：
<a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/" target="_blank" rel="noopener noreferrer">https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <blockquote><p>测试服务器</p></blockquote> <div class="language- line-numbers-mode"><pre class="language-text"><code>10.0.0.155
10.0.0.156
10.0.0.157
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="添加-yum-源"><a href="#添加-yum-源" class="header-anchor">#</a> 添加 <code>yum</code> 源</h2> <p>Configure the package management system (yum).
Create a <code>/etc/yum.repos.d/mongodb-org-4.0.repo</code> file so that you can install MongoDB directly using yum:</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>mongodb-org-4.0<span class="token punctuation">]</span>
<span class="token assign-left variable">name</span><span class="token operator">=</span>MongoDB Repository
<span class="token assign-left variable">baseurl</span><span class="token operator">=</span>https://repo.mongodb.org/yum/redhat/<span class="token variable">$releasever</span>/mongodb-org/4.0/x86_64/
<span class="token assign-left variable">gpgcheck</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">enabled</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token assign-left variable">gpgkey</span><span class="token operator">=</span>https://www.mongodb.org/static/pgp/server-4.0.asc
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">sudo</span> yum <span class="token function">install</span> -y mongodb-org
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="查看安装的位置"><a href="#查看安装的位置" class="header-anchor">#</a> 查看安装的位置</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment"># whereis mongod</span>
mongod: /usr/bin/mongod /etc/mongod.conf /usr/share/man/man1/mongod.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="每台服务器建立副本集测试文件夹"><a href="#每台服务器建立副本集测试文件夹" class="header-anchor">#</a> 每台服务器建立副本集测试文件夹</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#存放整个mongodb文件</span>
<span class="token function">mkdir</span> -p /data/mongodbtest/replset

<span class="token comment"># 配置文件</span>
<span class="token function">touch</span> /data/mongodbtest/replset/mongod.conf
 
<span class="token comment"># 存放mongodb数据文件</span>
<span class="token function">mkdir</span> -p /data/mongodbtest/replset/data

<span class="token comment"># 存放mongodb日志文件</span>
<span class="token function">mkdir</span> -p /data/mongodbtest/replset/log
<span class="token function">touch</span> /data/mongodbtest/replset/log/mongodbtest.log
 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="修改配置文件"><a href="#修改配置文件" class="header-anchor">#</a> 修改配置文件</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># mongod.conf</span>

<span class="token comment"># for documentation of all options, see:</span>
<span class="token comment">#   http://docs.mongodb.org/manual/reference/configuration-options/</span>

<span class="token comment"># where to write logging data.</span>
systemLog:
  destination: <span class="token function">file</span>
  logAppend: <span class="token boolean">true</span>
  path: /data/mongodbtest/replset/log/mongodbtest.log <span class="token comment"># 日志位置</span>

<span class="token comment"># Where and how to store data.</span>
storage:
  dbPath: /data/mongodbtest/replset/data <span class="token comment"># 数据库数据文件</span>
  journal:
    enabled: <span class="token boolean">true</span>
<span class="token comment">#  engine:</span>
<span class="token comment">#  mmapv1:</span>
<span class="token comment">#  wiredTiger:</span>

<span class="token comment"># how the process runs</span>
processManagement:
  fork: <span class="token boolean">true</span>  <span class="token comment"># fork and run in background</span>
  pidFilePath: /var/run/mongodb/mongod.pid  <span class="token comment"># location of pidfile</span>
  timeZoneInfo: /usr/share/zoneinfo

<span class="token comment"># network interfaces</span>
net:
  port: <span class="token number">27017</span>
  bindIp: <span class="token number">127.0</span>.0.1  <span class="token comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span>


<span class="token comment">#security:</span>

<span class="token comment">#operationProfiling:</span>
replication:
    replSetName: replset <span class="token comment"># 副本集名称</span>

<span class="token comment">#sharding:</span>

<span class="token comment">## Enterprise-Only Options</span>

<span class="token comment">#auditLog:</span>

<span class="token comment">#snmp:</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="每台服务器启动-mongodb"><a href="#每台服务器启动-mongodb" class="header-anchor">#</a> 每台服务器启动 <code>mongodb</code></h2> <div class="language- line-numbers-mode"><pre class="language-text"><code># 启动服务
$ /usr/bin/mongod -f /data/mongodbtest/replset/mongod.conf

# 停止服务
$ use admin
$ db.shutdownServer()
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="初始化副本集"><a href="#初始化副本集" class="header-anchor">#</a> 初始化副本集</h2> <blockquote><p><a href="https://www.cnblogs.com/ljai/p/4898475.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/ljai/p/4898475.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ mongo
<span class="token operator">&gt;</span> use admin
<span class="token comment"># 定义副本集配置</span>
<span class="token comment"># 键“_id”对应的值必须与配置文件中的replicaction.replSetName一致</span>
<span class="token comment"># priority代表权重[1,100]，大的被分配为主服务器，0永久不会变为主服务器</span>
<span class="token comment"># arbiterOnly:true 代表其为仲裁节点</span>

<span class="token comment"># 初始化副本集配置</span>
<span class="token operator">&gt;</span> rs.initiate<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 查看设置</span>
<span class="token operator">&gt;</span> rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 添加节点</span>
<span class="token operator">&gt;</span> rs.add<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.156:27017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> rs.add<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.157:27017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 查看状态</span>
<span class="token operator">&gt;</span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 出问题的话可以重置配置，副本集重置</span>
<span class="token operator">&gt;</span> <span class="token assign-left variable">conf</span><span class="token operator">=</span>rs.conf<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&gt;</span> conf.members<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>.host<span class="token operator">=</span><span class="token string">&quot;10.0.0.155:27017&quot;</span><span class="token punctuation">;</span>
<span class="token operator">&gt;</span> rs.reconfig<span class="token punctuation">(</span>conf,<span class="token punctuation">{</span><span class="token string">&quot;force&quot;</span>:true<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="查看副本集状态"><a href="#查看副本集状态" class="header-anchor">#</a> 查看副本集状态</h2> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>replset:PRIMARY<span class="token operator">&gt;</span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;replset&quot;</span>,
	<span class="token string">&quot;date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:43.540Z&quot;</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;myState&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
	<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;optimes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;lastCommittedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;readConcernMajorityOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;appliedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;durableOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>,
	<span class="token string">&quot;lastStableCheckpointTimestamp&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737423</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">0</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.155:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>, <span class="token comment"># 主节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">714</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;electionTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550736771</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;electionDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:12:51Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91697</span>,
			<span class="token string">&quot;self&quot;</span> <span class="token builtin class-name">:</span> true,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>, <span class="token comment"># 副本节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">11</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:41.964Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:42.982Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91697</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.157:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>, <span class="token comment"># 副本节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:39Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:41.963Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-21T08:24:42.789Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91697</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
	<span class="token string">&quot;operationTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;<span class="token variable">$clusterTime</span>&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;clusterTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1550737479</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
		<span class="token string">&quot;signature&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;hash&quot;</span> <span class="token builtin class-name">:</span> BinData<span class="token punctuation">(</span><span class="token number">0</span>,<span class="token string">&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;keyId&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br></div></div><h1 id="测试数据同步"><a href="#测试数据同步" class="header-anchor">#</a> 测试数据同步</h1> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试一，PRIMARY(1)上写数据，然后关闭PRIMARY（1）</span>
<span class="token comment">#  从新的PRIMARY（2）主机上查看，看数据是否同步</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 1.1 进入 10.0.0.155</span>
$ mongo

$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">26</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 输出 WriteResult({ &quot;nInserted&quot; : 1 })</span>

$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">23</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 输出 WriteResult({ &quot;nInserted&quot; : 1 })</span>

<span class="token comment"># 1.2 查看插入到 155 的数据</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>

<span class="token comment"># 1.3 停掉155数据库，连接156数据库,查看状态发现156 变成了PRIMARY</span>
$ mongo
<span class="token operator">&gt;</span> rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 1.4 156上查询数据，发现数据已经同步过来了</span>
<span class="token operator">&gt;</span> db.person.find<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>

<span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试二，在PRIMARY(2) 上写数据，然后关闭PRIMARY(2)</span>
<span class="token comment">#  观察PRIMARY(1)是否会重新恢复成PRIMARY</span>
<span class="token comment">#  观察PRIMARY(2)上写的数据是否会同步到PRIMARY(1)上</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 2.1 156上插入新数据</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.insert<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span><span class="token builtin class-name">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 输出 WriteResult({ &quot;nInserted&quot; : 1 })</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e690375369bb4020815d7&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>

<span class="token comment"># 2.2 启动155数据库，关闭156数据库，发现155数据库回重新变成在PRIMARY身份</span>
<span class="token comment"># 2.3 进入155数据库，查询，发现156上新增的数据也被同步过来了</span>
$ replset:PRIMARY<span class="token operator">&gt;</span> db.person.<span class="token function-name function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e653c1a3a9f9119c3c24f&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;张三&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">26</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e65851a3a9f9119c3c250&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;李四&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">23</span> <span class="token punctuation">}</span>
<span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> ObjectId<span class="token punctuation">(</span><span class="token string">&quot;5c6e690375369bb4020815d7&quot;</span><span class="token punctuation">)</span>, <span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;王五&quot;</span>, <span class="token string">&quot;age&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">25</span> <span class="token punctuation">}</span>

<span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试三，写入大量数据，观察数据同步是否成功</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 3.1 155上新建一个集合 peopleTest-155</span>
<span class="token comment"># 3.2 执行写库脚本,写入 100W 条数据</span>
$ node index.js
<span class="token comment"># 3.3 关闭155数据库</span>
<span class="token comment"># 3.4 去156查看副本集状态，发现157变成主节点</span>
$ rs.status<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 3.5 去157上查看数据状态</span>
$ use person <span class="token comment"># 切换到person库</span>
$ show tables <span class="token comment"># 展示所有的集合</span>
<span class="token comment"># 输出</span>
<span class="token comment"># people</span>
<span class="token comment"># peopleTest-155</span>
<span class="token comment"># 3.6 查询数据是否同步过来了</span>
$ db.peopleTest.find<span class="token punctuation">(</span><span class="token punctuation">)</span>.count<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 输出</span>
<span class="token comment"># 1000000</span>
<span class="token comment"># 结论：155 上写的数据已经被成功同步到了157上</span>

<span class="token comment"># ==========================================================================</span>
<span class="token comment">#  测试四，三个节点，1主2备，关闭2个节点，观察是否还可用</span>
<span class="token comment">#  结果：3个节点 =&gt; 2个节点(可用) =&gt; 1个节点(不可用)</span>
<span class="token comment"># ==========================================================================</span>
<span class="token comment"># 4.1</span>
<span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h3 id="_1主2备-只停掉主节点"><a href="#_1主2备-只停掉主节点" class="header-anchor">#</a> 1主2备：只停掉主节点</h3> <p>测试结果：<strong>正常</strong></p> <p>2个 <code>Secondary</code> 中会选出来一个 <code>PRIMARY</code></p> <h3 id="_1主2备-停掉2个节点"><a href="#_1主2备-停掉2个节点" class="header-anchor">#</a> 1主2备：停掉2个节点</h3> <p>测试结果：<strong>无法提供服务</strong></p> <p><u>测试1：依次停掉主、从节点</u></p> <p>① 先停掉 <code>PRIMARY</code>，2个 <code>SECONDARY</code> 中会选出来一个 <code>PRIMARY</code> 。<strong>正常</strong></p> <p>② 再停掉一个 <code>SECONDARY</code>，<code>PRIMARY</code> 最终会变成 <code>SECONDARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试2：依次停掉从、主节点</u></p> <p>① 先停掉一个 <code>SECONDARY</code>。<strong>正常</strong></p> <p>② 再停掉 <code>PRIMARY</code>，剩余的一个 <code>SECONDARY</code> 不会变成 <code>PRIMARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试3：停掉2个从节点</u></p> <p>① 先停掉一个 <code>SECONDARY</code>。<strong>正常</strong></p> <p>② 再停掉一个 <code>SECONDARY</code>，<code>PRIMARY</code> 最终会变成 <code>SECONDARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <h3 id="_1主1备-停掉一个节点"><a href="#_1主1备-停掉一个节点" class="header-anchor">#</a> 1主1备：停掉一个节点</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 在3个节点的情况下，移除 10.0.0.155</span>
$ rs.remove<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.155:27017&quot;</span><span class="token punctuation">)</span>
 <span class="token punctuation">{</span> <span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>

<span class="token comment"># 剩余2个节点，1主1备</span>
<span class="token comment"># 10.0.0.156 SECONDARY</span>
<span class="token comment"># 10.0.0.157 PRIMARY</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><u>测试1：</u>停掉 <code>PRIMARY</code>，<code>SECONDARY</code> 不会变成 <code>PRIMARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试2：</u>停掉 <code>SECONDARY</code>，<code>PRIMARY</code> 最终会变成 <code>SECONDARY</code>。<strong>没有主节点，副本集无法提供写服务</strong></p> <h3 id="_1主1备1仲裁"><a href="#_1主1备1仲裁" class="header-anchor">#</a> 1主1备1仲裁</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 在1主1备2个节点的情况下，添加一个仲裁节点</span>
<span class="token comment"># 仲裁节点，监控其他节点状态，参与选主投票，不参与数据保存</span>
<span class="token comment"># 方法一</span>
$ rs.add<span class="token punctuation">(</span><span class="token punctuation">{</span>host:<span class="token string">&quot;10.0.0.155:27017&quot;</span>,arbiterOnly:true<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment"># 或方法二</span>
$ rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.155:27017&quot;</span><span class="token punctuation">)</span>
$ rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.101:27017&quot;</span><span class="token punctuation">)</span>
$ rs.addArb<span class="token punctuation">(</span><span class="token string">&quot;10.0.0.102:27017&quot;</span><span class="token punctuation">)</span>
<span class="token comment"># 查看是否添加成功</span>
$ replset:ARBITER<span class="token operator">&gt;</span> rs.<span class="token function-name function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token string">&quot;set&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;replset&quot;</span>,
	<span class="token string">&quot;date&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:53.717Z&quot;</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;myState&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,
	<span class="token string">&quot;term&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
	<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
	<span class="token string">&quot;heartbeatIntervalMillis&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;optimes&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
		<span class="token string">&quot;lastCommittedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;readConcernMajorityOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;appliedOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>,
		<span class="token string">&quot;durableOpTime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
			<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">0</span>, <span class="token number">0</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span>-1<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>,
	<span class="token string">&quot;lastStableCheckpointTimestamp&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081735</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
	<span class="token string">&quot;members&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;PRIMARY&quot;</span>,
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">149</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:52.755Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:53.322Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;electionTime&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081143</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;electionDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T07:52:23Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91701</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.157:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">2</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;SECONDARY&quot;</span>,
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">149</span>,
			<span class="token string">&quot;optime&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDurable&quot;</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
				<span class="token string">&quot;ts&quot;</span> <span class="token builtin class-name">:</span> Timestamp<span class="token punctuation">(</span><span class="token number">1551081765</span>, <span class="token number">1</span><span class="token punctuation">)</span>,
				<span class="token string">&quot;t&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>,
			<span class="token string">&quot;optimeDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;optimeDurableDate&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:45Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeat&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:52.754Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatRecv&quot;</span> <span class="token builtin class-name">:</span> ISODate<span class="token punctuation">(</span><span class="token string">&quot;2019-02-25T08:02:53.337Z&quot;</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;pingMs&quot;</span> <span class="token builtin class-name">:</span> NumberLong<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.156:27017&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91701</span>
		<span class="token punctuation">}</span>,
		<span class="token punctuation">{</span>
			<span class="token string">&quot;_id&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">3</span>,
			<span class="token string">&quot;name&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;10.0.0.155:27017&quot;</span>,
			<span class="token string">&quot;health&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>,
			<span class="token string">&quot;state&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">7</span>,
			<span class="token string">&quot;stateStr&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;ARBITER&quot;</span>, <span class="token comment"># 仲裁节点</span>
			<span class="token string">&quot;uptime&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">151</span>,
			<span class="token string">&quot;syncingTo&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceHost&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;syncSourceId&quot;</span> <span class="token builtin class-name">:</span> -1,
			<span class="token string">&quot;infoMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>,
			<span class="token string">&quot;configVersion&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">91701</span>,
			<span class="token string">&quot;self&quot;</span> <span class="token builtin class-name">:</span> true,
			<span class="token string">&quot;lastHeartbeatMessage&quot;</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>,
	<span class="token string">&quot;ok&quot;</span> <span class="token builtin class-name">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br></div></div><p><u>测试1：</u>停掉 <code>PRIMARY</code>，<code>SECONDARY</code> 会自动变成 <code>PRIMARY</code>。<strong>正常</strong></p> <p><u>测试2：</u>停掉 <code>SECONDARY</code>，<code>PRIMARY</code> 保持主节点的状态。<strong>正常</strong></p> <p><u>测试3：</u>停掉 <code>ARBITER</code>。<strong>正常</strong></p> <h3 id="_1主1备3仲裁"><a href="#_1主1备3仲裁" class="header-anchor">#</a> 1主1备3仲裁</h3> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token comment"># 初始情况：</span>
<span class="token number">10.0</span>.0.155 仲裁节点
<span class="token number">10.0</span>.0.156 主节点
<span class="token number">10.0</span>.0.157 副本节点
<span class="token number">10.0</span>.0.101 仲裁节点
<span class="token number">10.0</span>.0.102 仲裁节点
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><u>测试1：</u><strong>（结论：停掉2个仲裁节点就不行了）</strong></p> <p>① 先停掉主节点，副本节点会自动变成主节点。<strong>正常</strong></p> <p>② 再停掉一个仲裁节点（10.0.0.155）。<strong>正常</strong></p> <p>③ 再停掉一个仲裁节点（10.0.0.101），主节点会变成副本节点。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试2：</u><strong>（结论：停掉2个仲裁节点就不行了）</strong></p> <p>① 先停掉副本节点，主节点保持不变。<strong>正常</strong></p> <p>② 再停掉一个仲裁节点（10.0.0.155）。<strong>正常</strong></p> <p>③ 再停掉一个仲裁节点（10.0.0.101），主节点会变成副本节点。<strong>没有主节点，副本集无法提供写服务</strong></p> <p><u>测试3：</u><strong>（结论：停掉2个仲裁节点就不行了）</strong></p> <p>① 先停掉1个仲裁节点（10.0.0.155）。<strong>正常</strong></p> <p>② 再停掉1个仲裁节点（10.0.0.101）。主节点服务器会直接down掉，退出ssh连接。</p> <p>再次启动主节点mongo时会报错：由于异常退出数据库导致的错误。<strong>异常</strong></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">[</span>root@localhost data<span class="token punctuation">]</span><span class="token comment"># /usr/bin/mongod -f /data/mongodbtest/replset/mongod.conf</span>
about to fork child process, waiting <span class="token keyword">until</span> server is ready <span class="token keyword">for</span> connections.
forked process: <span class="token number">2041</span>
ERROR: child process failed, exited with error number <span class="token number">48</span>
To see additional information <span class="token keyword">in</span> this output, start without the <span class="token string">&quot;--fork&quot;</span> option.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="附录"><a href="#附录" class="header-anchor">#</a> 附录</h2> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * file：index.js
 * 
 * npm i
 * node index.js
*/</span>

<span class="token string">'use strict'</span>

<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> async <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async'</span><span class="token punctuation">)</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://10.0.0.156:27017/person'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> con <span class="token operator">=</span> mongoose<span class="token punctuation">.</span>connection

<span class="token comment">// 随机生成字符串</span>
<span class="token keyword">function</span> <span class="token function">randomString</span><span class="token punctuation">(</span>
  length<span class="token punctuation">,</span>
  chars <span class="token operator">=</span> <span class="token string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token string">''</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> length<span class="token punctuation">;</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span>
    result <span class="token operator">+=</span> chars<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> chars<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span>
  <span class="token keyword">return</span> result
<span class="token punctuation">}</span>

<span class="token comment">// 写入的 Collection</span>
<span class="token keyword">const</span> <span class="token constant">COLLECTION</span> <span class="token operator">=</span> <span class="token string">'peopleTest-156'</span>
<span class="token comment">// 写入数据的总条数</span>
<span class="token keyword">const</span> <span class="token constant">TOTAL</span> <span class="token operator">=</span> <span class="token number">1000000</span>
<span class="token comment">// 并发控制，每次批量写1万条</span>
<span class="token keyword">const</span> <span class="token constant">LIMIT</span> <span class="token operator">=</span> <span class="token number">10000</span>

con<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>console<span class="token punctuation">,</span> <span class="token string">'连接数据库失败'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
con<span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span> age<span class="token operator">:</span> Number <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 第三个参数，为实际的 collection 的名字，避免自动转复数</span>
  <span class="token keyword">const</span> personModel <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token constant">COLLECTION</span><span class="token punctuation">,</span> schema<span class="token punctuation">,</span> <span class="token constant">COLLECTION</span><span class="token punctuation">)</span>

  <span class="token comment">// 每1万数据归为1组</span>
  <span class="token keyword">let</span> peopleArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">TOTAL</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> index <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>i <span class="token operator">/</span> <span class="token constant">LIMIT</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>peopleArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">)</span> peopleArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    peopleArr<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">person_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">randomString</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">99</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 控制并发，每次写1组数据（1W条），写完再写下一组</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">1</span>
  <span class="token keyword">const</span> startTime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  async<span class="token punctuation">.</span><span class="token function">mapLimit</span><span class="token punctuation">(</span>
    peopleArr<span class="token punctuation">,</span>
    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> time1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 批量写</span>
      personModel<span class="token punctuation">.</span><span class="token function">insertMany</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> docs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">callback</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">throw</span> err
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">组，耗时：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> time1<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        index<span class="token operator">++</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'==========='</span><span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> docs<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TOTAL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">条数据写入完成，总耗时:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ms</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br></div></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Anonymity94/Anonymity94.github.io/edit/v2/articles/mongo-test.md" target="_blank" rel="noopener noreferrer">发现错误？在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022-04-12 15:32:46</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f17bcff4.js" defer></script><script src="/assets/js/2.8e2eb0cc.js" defer></script><script src="/assets/js/16.7f69dad5.js" defer></script><script src="/assets/js/54.8f75818d.js" defer></script>
  </body>
</html>
